#!/bin/bash

echo "ğŸ†• DEPLOY TO NEW STAGING REPOSITORY"
echo "==================================="
echo ""
echo "ğŸ¯ Target: Brand New GitHub Repository + Vercel Project"
echo "ğŸ“ Repository: family-chore-calendar-staging"
echo "ğŸŒ URL: [Will be generated by Vercel]"
echo "ğŸ—„ï¸  Database: Fresh database with clean schema"
echo "ğŸ” OAuth: New Google OAuth client"
echo "ğŸ”’ Complete Independence: Separate from production"
echo ""

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    echo "âŒ Please run this script from your project root directory"
    echo "   (where package.json is located)"
    exit 1
fi

echo "ğŸ“‹ NEW REPOSITORY SETUP CHECKLIST"
echo "================================="
echo ""
echo "Before deploying, make sure you've completed:"
echo ""
echo "âœ… 1. Created new GitHub repository"
echo "   - Repository: family-chore-calendar-staging"
echo "   - Visibility: Private (recommended)"
echo "   - URL: https://github.com/king6870/family-chore-calendar-staging"
echo ""
echo "âœ… 2. Set up local repository"
echo "   - Cloned new repository"
echo "   - Copied project files"
echo "   - Committed initial code"
echo ""
echo "âœ… 3. Created new Vercel project"
echo "   - Imported new GitHub repository"
echo "   - Project name: family-chore-calendar-staging"
echo "   - Framework: Next.js"
echo ""
echo "âœ… 4. Created new database"
echo "   - Option A: Vercel Postgres"
echo "   - Option B: New Prisma Accelerate project"
echo "   - Got DATABASE_URL"
echo ""
echo "âœ… 5. Created new Google OAuth client"
echo "   - Name: Family Chore Calendar - Staging"
echo "   - Got Client ID and Secret"
echo ""
echo "âœ… 6. Set environment variables in Vercel"
echo "   - DATABASE_URL, NEXTAUTH_URL, GOOGLE_CLIENT_ID, etc."
echo ""

read -p "Have you completed all the above steps? (y/n): " setup_complete

if [ "$setup_complete" != "y" ] && [ "$setup_complete" != "Y" ]; then
    echo ""
    echo "âš ï¸  PLEASE COMPLETE SETUP FIRST"
    echo "==============================="
    echo ""
    echo "ğŸ“‹ Setup guide available: setup-new-github-repo.md"
    echo "ğŸ”„ Run this script again after completing setup"
    exit 1
fi

echo ""
echo "ğŸ“ REPOSITORY INFORMATION"
echo "========================"
echo ""
read -p "Enter your new staging repository name (default: family-chore-calendar-staging): " repo_name
repo_name=${repo_name:-family-chore-calendar-staging}

read -p "Enter your GitHub username: " github_username
read -s -p "Enter your GitHub Personal Access Token: " github_token
echo ""
echo ""

# Validate inputs
if [ -z "$github_username" ] || [ -z "$github_token" ]; then
    echo "âŒ Username and token are required"
    exit 1
fi

# Check if we're in a git repository
if [ ! -d ".git" ]; then
    echo "âŒ This directory is not a git repository"
    echo "ğŸ’¡ Make sure you're in your new staging repository directory"
    exit 1
fi

# Check current branch
current_branch=$(git branch --show-current)
echo "ğŸ“ Current branch: $current_branch"

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "âš ï¸  You have uncommitted changes"
    echo "ğŸ“‹ Uncommitted files:"
    git status --porcelain
    echo ""
    read -p "Do you want to commit these changes? (y/n): " commit_changes
    
    if [ "$commit_changes" = "y" ] || [ "$commit_changes" = "Y" ]; then
        read -p "Enter commit message: " commit_message
        git add .
        git commit -m "$commit_message"
        echo "âœ… Changes committed"
    else
        echo "âŒ Cannot deploy with uncommitted changes"
        exit 1
    fi
fi

echo ""
echo "ğŸš€ DEPLOYING TO NEW STAGING REPOSITORY..."
echo "========================================"

# Configure git with token temporarily
git remote set-url origin https://$github_username:$github_token@github.com/$github_username/$repo_name.git

# Push to repository (triggers Vercel deployment)
echo "ğŸ“¤ Pushing to GitHub repository..."
git push origin $current_branch

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… DEPLOYMENT TO NEW STAGING SUCCESSFUL!"
    echo "======================================="
    echo ""
    echo "ğŸ‰ Your fresh staging environment is being deployed!"
    echo "ğŸ“ Repository: https://github.com/$github_username/$repo_name"
    echo "â±ï¸  Vercel deployment usually takes 2-3 minutes"
    echo ""
    echo "ğŸ“‹ Next steps:"
    echo ""
    echo "1. ğŸŒ Get your staging URL from Vercel dashboard"
    echo "2. ğŸ” Update Google OAuth client with the new URL:"
    echo "   - Add JavaScript origin: https://[new-staging-url]"
    echo "   - Add redirect URI: https://[new-staging-url]/api/auth/callback/google"
    echo ""
    echo "3. ğŸ—„ï¸  Set up database schema:"
    echo "   - Run: NEW_STAGING_DATABASE_URL=\"your-url\" node setup-new-staging-database.js"
    echo ""
    echo "4. ğŸ§ª Test your new staging environment:"
    echo "   - Visit the new staging URL"
    echo "   - Test Google OAuth sign-in"
    echo "   - Create a test family"
    echo "   - Verify all features work"
    echo ""
    echo "5. ğŸ”„ Set up development workflow:"
    echo "   - Work in this repository for staging changes"
    echo "   - Sync with production repository as needed"
    echo ""
    echo "ğŸ¯ Benefits of your new setup:"
    echo "   âœ… Complete independence from production"
    echo "   âœ… No Vercel branch restrictions"
    echo "   âœ… Fresh database with proper schema"
    echo "   âœ… New OAuth client with correct URLs"
    echo "   âœ… Clean git history and configuration"
    echo "   âœ… Full control over staging environment"
    echo ""
else
    echo ""
    echo "âŒ DEPLOYMENT FAILED"
    echo "Check the error messages above"
    echo ""
    echo "ğŸ’¡ Common issues:"
    echo "   - Invalid GitHub token"
    echo "   - Repository doesn't exist"
    echo "   - Network connectivity"
    echo "   - Repository permissions"
fi

# Reset git remote for security
git remote set-url origin https://github.com/$github_username/$repo_name.git
echo "ğŸ” Git remote URL reset for security"

echo ""
echo "ğŸ New repository staging deployment completed"
